import{initializeApp as St}from"https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";import{getAuth as Mt,createUserWithEmailAndPassword as Ft,signInWithEmailAndPassword as Rt,signOut as kt,onAuthStateChanged as qt}from"https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";import{getFirestore as Ht,query as D,collection as T,where as S,orderBy as W,getDocs as M,startAfter as Ot,limit as dt,doc as vt,deleteDoc as Nt,addDoc as wt,arrayUnion as ut,updateDoc as _t}from"https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function o(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=o(n);fetch(n.href,a)}})();const Wt={apiKey:"VOTRE_API_KEY_ICI",authDomain:"mon-journal-de-trading-8914c.firebaseapp.com",projectId:"mon-journal-de-trading-8914c",storageBucket:"mon-journal-de-trading-8914c.firebasestorage.app",messagingSenderId:"107546442927",appId:"1:107546442927:web:692d6d43c08eb7e916a85a"},It=St(Wt),j=Mt(It),C=Ht(It);let L=new Date().getFullYear(),I=[],B=[],y=[],F=[],g=null;const _=20;let w=1,Q=1,K=null;const mt=document.getElementById("main-sidebar");document.getElementById("main-content-area");const Qt=document.getElementById("section-title"),Ct=document.querySelectorAll("#main-sidebar .nav-link"),Gt=document.querySelectorAll(".content-section"),yt=document.getElementById("user-display"),Ut=document.getElementById("logout-btn");document.getElementById("auth-section");const gt=document.getElementById("login-form"),pt=document.getElementById("signup-form"),G=document.getElementById("auth-error-message"),Vt=document.getElementById("loginEmail"),jt=document.getElementById("loginPassword"),Yt=document.getElementById("signupEmail"),zt=document.getElementById("signupPassword"),Y=document.getElementById("open-positions-body"),Jt=document.getElementById("show-new-position-form-btn"),z=document.getElementById("all-trades-body"),Z=document.getElementById("prev-page-btn"),X=document.getElementById("next-page-btn"),Kt=document.getElementById("pagination-info"),H=document.getElementById("total-profit-loss"),ft=document.getElementById("win-rate"),ht=document.getElementById("total-trades"),O=document.getElementById("last-trades-body"),ot=new bootstrap.Modal(document.getElementById("positionModal")),Bt=document.getElementById("positionModalLabel"),U=document.getElementById("position-form"),st=document.getElementById("positionId"),at=document.getElementById("formAction"),Zt=document.getElementById("positionAsset"),Xt=document.getElementById("positionType"),rt=document.getElementById("transactionDate"),xt=document.getElementById("transactionQuantity"),te=document.getElementById("transactionPrice");document.getElementById("positionNotes");const ee=document.getElementById("save-position-btn"),Lt=document.getElementById("asset-group"),Pt=document.getElementById("type-group"),$t=document.getElementById("notes-group");function At(t){G.textContent=t,G.classList.remove("d-none")}function Dt(){G.classList.add("d-none"),G.textContent=""}pt.addEventListener("submit",async t=>{t.preventDefault(),Dt();try{await Ft(j,Yt.value,zt.value),pt.reset()}catch(e){At(e.message)}});gt.addEventListener("submit",async t=>{t.preventDefault(),Dt();try{await Rt(j,Vt.value,jt.value),gt.reset()}catch(e){At(e.message)}});Ut.addEventListener("click",()=>{kt(j)});qt(j,async t=>{t?(g=t,yt.textContent=t.email,mt.classList.remove("d-none"),w=1,Q=1,K=null,await Promise.all([it(),$(),ct()]),R(),Tt(localStorage.getItem("theme")||"light"),tt("dashboard")):(g=null,I=[],B=[],F=[],yt.textContent="",mt.classList.add("d-none"),R(),tt("auth-section"))});async function it(){if(g)try{const t=D(T(C,"users",g.uid,"positions"),S("status","==","open"),W("createdAt","desc")),e=D(T(C,"users",g.uid,"accountTransactions")),[o,s]=await Promise.all([M(t),M(e)]);I=o.docs.map(n=>({id:n.id,...n.data()})),F=s.docs.map(n=>({id:n.id,...n.data()})),I.forEach(n=>{n.entries&&n.entries.forEach(a=>a.date=a.date.toDate())}),F.forEach(n=>n.date=n.date.toDate())}catch(t){console.error("Erreur de chargement des données statiques:",t)}}async function $(t=null){if(g)try{const e=T(C,"users",g.uid,"positions");let o;if(t==="next")o=D(e,S("status","==","closed"),W("createdAt","desc"),Ot(K),dt(_));else if(o=D(e,S("status","==","closed"),W("createdAt","desc"),dt(_)),t===null){const n=D(e,S("status","==","closed")),a=await M(n);Q=Math.ceil(a.size/_)||1}const s=await M(o);s.empty||(K=s.docs[s.docs.length-1]),B=s.docs.map(n=>({id:n.id,...n.data()})),B.forEach(n=>{n.entries&&n.entries.forEach(a=>a.date=a.date.toDate()),n.exits&&n.exits.forEach(a=>a.date=a.date.toDate())}),ne(s.size)}catch(e){console.error("Erreur de chargement des données paginées:",e)}}async function ct(){if(g)try{y=[];const t=D(T(C,"users",g.uid,"positions"),S("status","==","closed"),W("createdAt","desc")),e=await M(t),o=[];e.forEach(s=>{o.push({id:s.id,...s.data()})}),o.forEach(s=>{s.entries&&s.entries.forEach(n=>n.date=n.date.toDate()),s.exits&&s.exits.forEach(n=>n.date=n.date.toDate())}),y=o}catch(t){console.error("Erreur lors du chargement de toutes les positions clôturées:",t)}}function ne(t){Kt.textContent=`Page ${w} sur ${Q}`,Z.disabled=w===1,X.disabled=w===Q||t<_}async function R(){oe(),et(),ae(),se(),k(),re(),ie(),ce()}function tt(t){Ct.forEach(s=>s.classList.remove("active")),Gt.forEach(s=>s.classList.remove("active"));const e=document.getElementById(t);e&&(e.classList.add("active"),(t==="dashboard"||t==="reports-analytics")&&k());const o=document.querySelector(`.nav-link[data-section="${t}"]`);o&&o.classList.add("active"),Qt.textContent=o?o.textContent.trim():"Authentification"}function oe(){if(Y.innerHTML="",I.length===0){Y.innerHTML='<tr><td colspan="6" class="text-center">Aucune position ouverte.</td></tr>';return}I.forEach(t=>{const e=q(t),o=Y.insertRow();o.innerHTML=`
            <td>${t.asset}</td>
            <td>${t.type==="long"?"Achat":"Vente"}</td>
            <td>${e.currentQuantity}</td>
            <td>${e.averageEntryPrice.toFixed(4)} ${t.currency}</td>
    <td>${(e.currentQuantity*e.averageEntryPrice).toFixed(2)} ${t.currency}</td>
            <td>
                <button class="btn btn-sm btn-success me-2" onclick="handleModifyPosition('${t.id}', 'add')">Renforcer</button>
                <button class="btn btn-sm btn-warning" onclick="handleModifyPosition('${t.id}', 'close')">Clôturer</button>
            </td>`})}function et(){if(z.innerHTML="",B.length===0){z.innerHTML='<tr><td colspan="8" class="text-center">Aucune position clôturée.</td></tr>';return}B.forEach(t=>{const e=q(t),o=v(t),s=z.insertRow();s.innerHTML=`
    <td>${A(t.entries[0].date)}</td>
    <td>${A(P(t))}</td>
    <td>${t.asset}</td>
    <td>${t.type==="long"?"Achat":"Vente"}</td>
    <td>${e.averageEntryPrice.toFixed(4)}</td>
    <td>${(e.totalExitValue/e.totalExitQuantity||0).toFixed(4)}</td>
    <td style="color: ${o>=0?"green":"red"};">${o.toFixed(2)} ${t.currency}</td>
    <td>
        <button class="btn btn-sm btn-info me-2" onclick="viewPositionDetails('${t.id}')">Détails</button>
        <button class="btn btn-sm btn-danger" onclick="deletePosition('${t.id}')">Supprimer</button>
    </td>`})}function se(){console.log("--- DIAGNOSTIC TABLEAU DE BORD ---"),console.log("Nombre total de positions pour les stats :",y.length);const t={};let e=0;y.forEach(s=>{const n=v(s),a=(s.currency||"INCONNU").toUpperCase();t[a]||(t[a]=0),t[a]+=n,n>=0&&e++});const o=y.length>0?e/y.length*100:0;if(console.log(`Calcul du Win Rate: ${e} (gains) / ${y.length} (total) = ${o.toFixed(2)}%`),H){H.innerHTML="";const s=Object.keys(t).sort();s.length===0?H.innerHTML="0.00":s.forEach(n=>{const a=t[n],i=a>=0?"green":"red";H.innerHTML+=`<div style="color: ${i}; font-size: 0.8em;">${a.toFixed(2)} ${n}</div>`})}ft&&(ft.textContent=`${o.toFixed(2)}%`),ht&&(ht.textContent=y.length)}function ae(){if(!O)return;O.innerHTML="";const t=B.slice(0,5);if(t.length===0){O.innerHTML='<tr><td colspan="4" class="text-center">Aucune position clôturée récente.</td></tr>';return}t.forEach(e=>{const o=v(e),s=O.insertRow();s.innerHTML=`
            <td>${A(P(e))}</td>
            <td>${e.asset}</td>
            <td>${e.type==="long"?"Achat":"Vente"}</td>
            <td style="color: ${o>=0?"green":"red"};">${o.toFixed(2)} ${e.currency}</td>
        `})}function k(){window.performanceChartInstance&&window.performanceChartInstance.destroy(),window.monthlyPnLChartInstance&&window.monthlyPnLChartInstance.destroy(),window.winRateByAssetChartInstance&&window.winRateByAssetChartInstance.destroy(),window.monthlyActivityChartInstance&&window.monthlyActivityChartInstance.destroy(),window.longShortPnlChartInstance&&window.longShortPnlChartInstance.destroy(),window.avgWinLossChartInstance&&window.avgWinLossChartInstance.destroy();const t=["Jan","Fév","Mar","Avr","Mai","Juin","Juil","Aoû","Sep","Oct","Nov","Déc"],e=y.filter(r=>{const l=P(r);return l instanceof Date&&l.getFullYear()===L});le();const o=document.getElementById("performanceChart");if(o){const r=y.map(d=>({...d,closingDate:P(d)})).filter(d=>d.closingDate instanceof Date).sort((d,u)=>d.closingDate-u.closingDate),l=r.map(d=>A(d.closingDate)),p={},c={},h=[...new Set(r.map(d=>d.currency))];h.forEach(d=>{p[d]=0,c[d]=[]}),r.forEach(d=>{p[d.currency]+=v(d),h.forEach(u=>{c[u].push(p[u])})});const E=["rgb(75, 192, 192)","rgb(255, 99, 132)","rgb(255, 205, 86)"],x=h.map((d,u)=>({label:`Performance Cumulative (${d})`,data:c[d],borderColor:E[u%E.length],tension:.1,fill:!1}));window.performanceChartInstance=new Chart(o,{type:"line",data:{labels:l,datasets:x},options:{responsive:!0,plugins:{legend:{position:"top"},title:{display:!0,text:"Courbe de Performance Cumulative par Devise"}}}})}const s=document.getElementById("monthlyPnLChart");if(s){const r=Array(12).fill(0);e.forEach(l=>{const p=P(l);r[p.getMonth()]+=v(l)}),window.monthlyPnLChartInstance=new Chart(s,{type:"bar",data:{labels:t,datasets:[{label:"Profit/Perte Net Mensuel",data:r,backgroundColor:r.map(l=>l>=0?"rgba(75, 192, 192, 0.6)":"rgba(255, 99, 132, 0.6)")}]}})}const n=document.getElementById("winRateByAssetChart");if(n){const r={};y.forEach(c=>{r[c.asset]||(r[c.asset]={total:0,wins:0}),r[c.asset].total++,v(c)>=0&&r[c.asset].wins++});const l=Object.keys(r),p=l.map(c=>r[c].wins/r[c].total*100);window.winRateByAssetChartInstance=new Chart(n,{type:"bar",data:{labels:l,datasets:[{label:"Taux de Réussite (%)",data:p,backgroundColor:"rgba(54, 162, 235, 0.6)"}]},options:{scales:{y:{beginAtZero:!0,max:100}}}})}const a=document.getElementById("monthlyActivityChart");if(a){const r=Array(12).fill(0),l=Array(12).fill(0);e.forEach(c=>{const h=P(c).getMonth();r[h]++,v(c)>=0&&l[h]++});const p=r.map((c,h)=>c>0?l[h]/c*100:0);window.monthlyActivityChartInstance=new Chart(a,{type:"bar",data:{labels:t,datasets:[{type:"bar",label:"Nombre de Trades",data:r,backgroundColor:"rgba(54, 162, 235, 0.6)",yAxisID:"yTrades"},{type:"line",label:"Taux de Gain (%)",data:p,borderColor:"rgba(255, 159, 64, 1)",backgroundColor:"rgba(255, 159, 64, 0.6)",yAxisID:"yWinRate",tension:.1}]},options:{scales:{yTrades:{type:"linear",position:"left",beginAtZero:!0,title:{display:!0,text:"Nombre de Trades"}},yWinRate:{type:"linear",position:"right",min:0,max:100,title:{display:!0,text:"Taux de Gain (%)"},grid:{drawOnChartArea:!1}}}}})}const i=document.getElementById("longShortPnlChart"),f=document.getElementById("longShortStatsDisplay");if(i&&f){const r={long:{totalPnl:0,wins:0,count:0},short:{totalPnl:0,wins:0,count:0}};y.forEach(E=>{const x=v(E);(E.type==="long"||E.type==="short")&&(r[E.type].count++,r[E.type].totalPnl+=x,x>=0&&r[E.type].wins++)});const l=Math.max(0,r.long.totalPnl),p=Math.max(0,r.short.totalPnl);window.longShortPnlChartInstance=new Chart(i,{type:"doughnut",data:{labels:['Profits générés par "Long"','Profits générés par "Short"'],datasets:[{data:[l,p],backgroundColor:["rgba(75, 192, 192, 0.7)","rgba(255, 99, 132, 0.7)"],borderColor:["rgba(75, 192, 192, 1)","rgba(255, 99, 132, 1)"],borderWidth:1}]},options:{responsive:!0,plugins:{legend:{display:!1}}}});const c=r.long.count>0?r.long.wins/r.long.count*100:0,h=r.short.count>0?r.short.wins/r.short.count*100:0;f.innerHTML=`<table class="table table-sm table-borderless small"><thead><tr><th>Type</th><th class="text-end">P/L Total</th><th class="text-end">Taux Gain</th><th class="text-end">Trades</th></tr></thead><tbody><tr><td><span class="badge" style="background-color: rgba(75, 192, 192, 0.7);">Long</span></td><td class="text-end" style="color:${r.long.totalPnl>=0?"green":"red"}"><strong>${r.long.totalPnl.toFixed(2)}</strong></td><td class="text-end">${c.toFixed(1)}%</td><td class="text-end">${r.long.count}</td></tr><tr><td><span class="badge" style="background-color: rgba(255, 99, 132, 0.7);">Short</span></td><td class="text-end" style="color:${r.short.totalPnl>=0?"green":"red"}"><strong>${r.short.totalPnl.toFixed(2)}</strong></td><td class="text-end">${h.toFixed(1)}%</td><td class="text-end">${r.short.count}</td></tr></tbody></table>`}const m=document.getElementById("avgWinLossChart"),lt=document.getElementById("avgWinLossStatsDisplay");if(m&&lt){const r=[],l=[];y.forEach(u=>{const b=v(u);b>0?r.push(b):b<0&&l.push(Math.abs(b))});const p=r.length>0?r.reduce((u,b)=>u+b,0)/r.length:0,c=l.length>0?l.reduce((u,b)=>u+b,0)/l.length:0;window.avgWinLossChartInstance=new Chart(m,{type:"bar",data:{labels:["Gain Moyen","Perte Moyenne"],datasets:[{data:[p,c],backgroundColor:["rgba(75, 192, 192, 0.7)","rgba(255, 99, 132, 0.7)"],borderColor:["rgba(75, 192, 192, 1)","rgba(255, 99, 132, 1)"],borderWidth:1}]},options:{scales:{y:{beginAtZero:!0}},plugins:{legend:{display:!1}}}});const h=r.reduce((u,b)=>u+b,0),E=l.reduce((u,b)=>u+b,0),x=E>0?h/E:1/0,d=c>0?p/c:1/0;lt.innerHTML=`<p class="mb-1">Ratio Risque/Rendement Réalisé : <strong style="font-size: 1.2em; color: ${d>=1?"green":"red"};">${d.toFixed(2)} : 1</strong></p><small class="text-muted">(Pour chaque 1 unité de risque, vous avez gagné ${d.toFixed(2)} unités en moyenne)</small><hr class="my-2"><p class="mb-1">Profit Factor : <strong style="font-size: 1.2em; color: ${x>=1?"green":"red"};">${x.toFixed(2)}</strong></p><small class="text-muted">(Total des Gains / Total des Pertes)</small>`}}Jt.addEventListener("click",()=>{U.reset(),st.value="",at.value="open",Bt.textContent="Ouvrir une Nouvelle Position",[Lt,Pt,$t].forEach(t=>t.style.display="block"),rt.value=new Date().toISOString().slice(0,16),ot.show()});window.handleModifyPosition=(t,e)=>{const o=I.find(s=>s.id===t);o&&(U.reset(),st.value=t,at.value=e,Zt.value=o.asset,Xt.value=o.type,[Lt,Pt,$t].forEach(s=>s.style.display="none"),Bt.textContent=e==="add"?`Renforcer ${o.asset}`:`Clôturer ${o.asset}`,e==="close"&&(xt.value=q(o).currentQuantity),rt.value=new Date().toISOString().slice(0,16),ot.show())};window.viewPositionDetails=t=>{const e=[...I,...B].find(s=>s.id===t);if(!e)return;let o=`Détails pour ${e.asset}:

--- ENTRÉES ---
`;e.entries.forEach(s=>{o+=`${A(s.date)} - Qte: ${s.quantity}, Prix: ${s.price} ${e.currency}
`}),o+=`
--- SORTIES ---
`,e.exits&&e.exits.length>0?e.exits.forEach(s=>{o+=`${A(s.date)} - Qte: ${s.quantity}, Prix: ${s.price} ${e.currency}
`}):o+=`Aucune sortie pour le moment.
`,alert(o)};window.deletePosition=async t=>{Swal.fire({title:"Êtes-vous sûr ?",text:"Cette action est irréversible et supprimera définitivement la position.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Oui, supprimer !",cancelButtonText:"Annuler"}).then(async e=>{if(e.isConfirmed)try{const o=vt(C,"users",g.uid,"positions",t);await Nt(o),w=1,await Promise.all([it(),$(),ct()]),R(),Swal.fire("Supprimée !","La position a été supprimée avec succès.","success")}catch(o){console.error("Erreur lors de la suppression de la position :",o),Swal.fire("Erreur","Une erreur est survenue lors de la suppression.","error")}})};ee.addEventListener("click",async()=>{if(!U.checkValidity()){U.reportValidity();return}const t=at.value,e=st.value,o={date:new Date(rt.value),quantity:parseFloat(xt.value),price:parseFloat(te.value),fees:.36};try{if(t==="open"){const s={asset:document.getElementById("positionAsset").value.toUpperCase(),type:document.getElementById("positionType").value,currency:document.getElementById("positionCurrency").value.toUpperCase(),status:"open",notes:document.getElementById("positionNotes").value,createdAt:o.date,entries:[o],exits:[]};await wt(T(C,"users",g.uid,"positions"),s)}else{const s=vt(C,"users",g.uid,"positions",e),n={};if(t==="add")n.entries=ut(o);else if(t==="close"){const a=I.find(f=>f.id===e),i=q(a);if(o.quantity>i.currentQuantity+1e-9){alert("Erreur : Quantité de sortie supérieure à la quantité détenue.");return}n.exits=ut(o),Math.abs(o.quantity-i.currentQuantity)<1e-9&&(n.status="closed")}await _t(s,n)}ot.hide(),w=1,await Promise.all([it(),$(),ct()]),R()}catch(s){console.error("Erreur sauvegarde position :",s),alert("Erreur lors de la sauvegarde.")}});const Et=document.getElementById("account-form"),V=document.getElementById("transactionType"),N=document.getElementById("balances-display"),J=document.getElementById("transactions-history-body"),bt=document.getElementById("deposit-withdrawal-group"),nt=document.getElementById("conversion-group");function re(){if(!N)return;const t={};F.forEach(n=>{const a=(n.fromCurrency||n.currency||"").toUpperCase(),i=(n.toCurrency||n.currency||"").toUpperCase(),f=n.fromAmount||n.amount||0,m=n.toAmount||n.amount||0;if(!a&&!i){console.warn("Transaction ignorée car aucune devise n'est spécifiée :",n);return}a&&!t[a]&&(t[a]=0),i&&!t[i]&&(t[i]=0),n.type==="deposit"&&(t[i]+=m),n.type==="withdrawal"&&(t[a]-=f),n.type==="conversion"&&(a&&(t[a]-=f),i&&(t[i]+=m))}),y.forEach(n=>{if(n.currency){const a=v(n),i=n.currency.toUpperCase();t[i]||(t[i]=0),t[i]+=a}}),N.innerHTML="";const e=Object.keys(t).sort();if(e.length===0){N.innerHTML='<p class="text-muted">Aucune transaction pour le moment.</p>';return}const o=document.createElement("table");o.className="table table-sm mb-0",o.innerHTML="<tbody></tbody>";const s=o.querySelector("tbody");e.forEach(n=>{Math.abs(t[n])>.001&&(s.innerHTML+=`
                <tr>
                    <td><strong>${n}</strong></td>
                    <td class="text-end">${t[n].toFixed(2)}</td>
                </tr>`)}),N.appendChild(o)}function ie(){J.innerHTML="";const t=[...F].sort((e,o)=>o.date-e.date);if(t.length===0){J.innerHTML='<tr><td colspan="2" class="text-center">Aucun historique.</td></tr>';return}t.forEach(e=>{const o=J.insertRow();let s="";e.type==="deposit"?s=`<span class="text-success">Dépôt de ${e.amount.toFixed(2)} ${e.currency}</span>`:e.type==="withdrawal"?s=`<span class="text-danger">Retrait de ${e.amount.toFixed(2)} ${e.currency}</span>`:e.type==="conversion"&&(s=`Conversion de ${e.fromAmount.toFixed(2)} ${e.fromCurrency} <br> <small class="text-muted">→ ${e.toAmount.toFixed(2)} ${e.toCurrency} (Taux: ${e.rate})</small>`),o.innerHTML=`<td>${A(e.date)}</td><td>${s}</td>`})}V.addEventListener("change",()=>{V.value==="conversion"?(bt.classList.add("d-none"),nt.classList.remove("d-none")):(bt.classList.remove("d-none"),nt.classList.add("d-none"))});nt.addEventListener("input",()=>{const t=parseFloat(document.getElementById("conv_from_amount").value)||0,e=parseFloat(document.getElementById("conv_rate").value)||0;document.getElementById("conv_to_amount_display").textContent=(t*e).toFixed(2)});Et.addEventListener("submit",async t=>{if(t.preventDefault(),!g)return;let e;const o=V.value;if(o==="deposit"||o==="withdrawal")e={type:o,date:new Date(document.getElementById("dw_date").value),amount:parseFloat(document.getElementById("dw_amount").value),currency:document.getElementById("dw_currency").value.toUpperCase()};else{const s=parseFloat(document.getElementById("conv_from_amount").value),n=parseFloat(document.getElementById("conv_rate").value);e={type:"conversion",date:new Date(document.getElementById("conv_date").value),fromAmount:s,fromCurrency:document.getElementById("conv_from_currency").value.toUpperCase(),toAmount:s*n,toCurrency:document.getElementById("conv_to_currency").value.toUpperCase(),rate:n}}try{await wt(T(C,"users",g.uid,"accountTransactions"),e),Et.reset(),V.dispatchEvent(new Event("change")),await $(),R()}catch(s){console.error("Erreur enregistrement transaction:",s),alert("Erreur lors de l'enregistrement.")}});function A(t){if((!t||typeof t.toDate!="function")&&(!(t instanceof Date)||isNaN(t)))return"Date invalide";const e=t.toDate?t.toDate():t,o={year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"};return e.toLocaleDateString("fr-FR",o)}function ce(){const t=[...I,...B],e=[...new Set(t.map(a=>a.asset).filter(Boolean))],o=[...new Set(t.map(a=>a.currency).filter(Boolean))],s=document.getElementById("asset-list"),n=document.getElementById("currency-list");s&&(s.innerHTML=e.map(a=>`<option value="${a}"></option>`).join("")),n&&(n.innerHTML=o.map(a=>`<option value="${a}"></option>`).join(""))}function q(t){let e=0,o=0,s=0;t.entries.forEach(m=>{e+=m.quantity,o+=m.quantity*m.price,s+=m.fees||0});let n=0,a=0,i=0;t.exits&&t.exits.forEach(m=>{n+=m.quantity,a+=m.quantity*m.price,i+=m.fees||0});const f=s+i;return{currentQuantity:e-n,averageEntryPrice:o/e||0,totalExitValue:a,totalExitQuantity:n,totalCost:o,totalQuantity:e,totalFees:f}}function v(t){const e=q(t);let o=0;return t.type==="long"?o=e.totalExitValue-e.totalCost:o=e.totalCost-e.totalExitValue,o-e.totalFees}function P(t){return!t.exits||t.exits.length===0?null:t.exits.reduce((e,o)=>o.date>e?o.date:e,t.exits[0].date)}function le(){document.getElementById("pnl-current-year").textContent=L,document.getElementById("activity-current-year").textContent=L;const t=[...new Set(y.map(a=>P(a)?.getFullYear()).filter(Boolean))],e=Math.min(...t),o=Math.max(...t),s=L<=e,n=L>=o;document.getElementById("pnl-prev-year").disabled=s,document.getElementById("activity-prev-year").disabled=s,document.getElementById("pnl-next-year").disabled=n,document.getElementById("activity-next-year").disabled=n}function Tt(t){const e=t==="dark",o=e?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)",s=e?"#e0e0e0":"#666";Chart.defaults.color=s,Chart.defaults.borderColor=o,(document.getElementById("reports-analytics").classList.contains("active")||document.getElementById("dashboard").classList.contains("active"))&&k()}document.addEventListener("DOMContentLoaded",()=>{Ct.forEach(i=>{i.addEventListener("click",f=>{f.preventDefault(),g&&tt(f.currentTarget.dataset.section)})}),X.addEventListener("click",async()=>{X.disabled||(w++,await $("next"),et())}),Z.addEventListener("click",async()=>{if(!Z.disabled){w--,await $();for(let i=1;i<w;i++)await $("next");et()}}),[{prev:"pnl-prev-year",next:"pnl-next-year"},{prev:"activity-prev-year",next:"activity-next-year"}].forEach(i=>{document.getElementById(i.prev).addEventListener("click",()=>{L--,k()}),document.getElementById(i.next).addEventListener("click",()=>{L++,k()})});const e=document.getElementById("theme-toggle-btn"),o=document.body,s=e.querySelector("i"),n=i=>{i==="dark"?(o.classList.add("dark-mode"),s&&s.classList.replace("bi-sun-fill","bi-moon-fill")):(o.classList.remove("dark-mode"),s&&s.classList.replace("bi-moon-fill","bi-sun-fill")),Tt(i)},a=localStorage.getItem("theme")||"light";n(a),e.addEventListener("click",()=>{const i=o.classList.contains("dark-mode")?"light":"dark";localStorage.setItem("theme",i),n(i)})});
